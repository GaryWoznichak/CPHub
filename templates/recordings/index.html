{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <!-- Header Section -->
    <div class="dashboard-header">
        {% if is_customer_view and customer %}
        <!-- Customer View Header -->
        <div>
            <h1><i class="fas fa-video"></i> {{ customer.customer_name }} - Video Recordings</h1>
            <div class="customer-info">
                <span class="customer-code">{{ customer.customer_code }}</span>
                <span class="isolation-badge"><i class="fas fa-lock"></i> Secure Isolation Active</span>
            </div>
        </div>
        {% else %}
        <!-- System Admin View Header -->
        <h1><i class="fas fa-video"></i> Video Recordings</h1>
        {% endif %}
    </div>

    <!-- Coming Soon Placeholder -->
    <!-- Replace the placeholder section with this: -->
<div class="recordings-content">
    <div class="recordings-controls">
        <button onclick="syncVideos()" class="btn btn-primary">
            <i class="fas fa-sync"></i> Sync from Devices
        </button>
        <button onclick="refreshList()" class="btn btn-secondary">
            <i class="fas fa-refresh"></i> Refresh
        </button>
    </div>
    
    <div class="videos-grid" id="videos-container">
        <!-- Videos will load here -->
    </div>
</div>

<script>
function loadVideos() {
    fetch('/api/recordings')
        .then(response => response.json())
        .then(videos => {
            const container = document.getElementById('videos-container');
            if (videos.length === 0) {
                container.innerHTML = '<p>No videos found. Click "Sync from Devices" to download videos.</p>';
                return;
            }
            
            container.innerHTML = videos.map(video => `
                <div class="video-card">
                    <h4>${video.filename}</h4>
                    <p>Size: ${video.size} MB</p>
                    <p>Date: ${video.date}</p>
                    <button onclick="downloadVideo('${video.filename}')" class="btn btn-primary">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            `).join('');
        });
}

function downloadVideo(filename) {
    window.open(`/api/recordings/download/${filename}`, '_blank');
}

function syncVideos() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    // Show loading state
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
    button.disabled = true;
    
    // Call the download endpoint for device 1 (and later all devices)
    fetch('/api/devices/1/download_videos', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Downloaded ${data.downloaded_count} videos from ${data.message}`);
            // Refresh the video list to show new downloads
            loadVideos();
        } else {
            alert(`Sync failed: ${data.error}`);
        }
    })
    .catch(error => {
        alert(`Sync error: ${error.message}`);
    })
    .finally(() => {
        // Restore button
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function refreshList() {
    loadVideos();
}

// Load videos when page loads
document.addEventListener('DOMContentLoaded', loadVideos);
</script>
</div>

<style>
.recordings-placeholder {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 400px;
    background: #34495e;
    border-radius: 8px;
    border: 2px dashed #2c3e50;
}

.placeholder-content {
    text-align: center;
    color: #ecf0f1;
    max-width: 500px;
}

.placeholder-content i {
    color: #bdc3c7;
    margin-bottom: 20px;
}

.placeholder-content h3 {
    color: #ecf0f1;
    margin-bottom: 15px;
}

.placeholder-content p {
    color: #bdc3c7;
    margin-bottom: 30px;
}

.feature-list ul {
    list-style: none;
    padding: 0;
}

.feature-list li {
    padding: 8px 0;
    color: #bdc3c7;
}

.feature-list i {
    color: #3498db;
    margin-right: 10px;
    width: 20px;
}
</style>
{% endblock %}