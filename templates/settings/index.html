{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h2><i class="fas fa-cog"></i> System Settings</h2>
    
    <div class="settings-grid">
        <!-- System Configuration -->
        <div class="settings-section">
            <div class="section-header">
                <h4><i class="fas fa-server"></i> System Configuration</h4>
            </div>
            <div class="section-content">
                <a href="{{ url_for('manage_keys') }}" class="settings-item">
                    <div class="item-details">
                        <div class="item-title">Registration Keys</div>
                        <div class="item-description">View and manage device registration keys</div>
                    </div>
                </a>
                
                <a href="#" class="settings-item disabled">
                    <div class="item-details">
                        <div class="item-title">Network Configuration</div>
                        <div class="item-description">Configure IP settings and network options</div>
                    </div>
                </a>
                
                <a href="#" class="settings-item disabled">
                    <div class="item-details">
                        <div class="item-title">Time & Date</div>
                        <div class="item-description">System time zone and NTP settings</div>
                    </div>
                </a>
            </div>
        </div>

        <!-- Updates -->
        <div class="settings-section">
            <div class="section-header">
                <h4><i class="fas fa-download"></i> System Updates</h4>
            </div>
            <div class="section-content">
                <div class="settings-item">
                    <div class="item-details">
                        <div class="item-title">Software Updates</div>
                        <div class="item-description">Check for and install updates from GitHub</div>
                        <div class="update-status" id="update-status">
                            <div class="status-row">
                                <span class="label">Current Commit:</span>
                                <span class="value" id="current-commit">Loading...</span>
                            </div>
                            <div class="status-row">
                                <span class="label">Last Check:</span>
                                <span class="value" id="last-check">Never</span>
                            </div>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="update-button" id="check-updates-btn">
                            <i class="fas fa-refresh"></i>Check for Updates
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Device Management -->
        <div class="settings-section">
            <div class="section-header">
                <h4><i class="fas fa-devices"></i> Device Management</h4>
            </div>
            <div class="section-content">
                <a href="{{ url_for('list_devices') }}" class="settings-item">
                    <div class="item-details">
                        <div class="item-title">Manage Devices</div>
                        <div class="item-description">View, edit, and configure devices</div>
                    </div>
                </a>
                
                <a href="{{ url_for('add_device') }}" class="settings-item">
                    <div class="item-details">
                        <div class="item-title">Add New Device</div>
                        <div class="item-description">Register a new CyberPhysical device</div>
                    </div>
                </a>
                
                <a href="#" class="settings-item disabled">
                    <div class="item-details">
                        <div class="item-title">Connection Testing</div>
                        <div class="item-description">Test connectivity to all devices</div>
                    </div>
                </a>
            </div>
        </div>

        <!-- Security & Monitoring -->
        <div class="settings-section">
            <div class="section-header">
                <h4><i class="fas fa-shield-alt"></i> Security & Monitoring</h4>
            </div>
            <div class="section-content">
                <a href="{{ url_for('change_password') }}" class="settings-item">
                    <div class="item-details">
                        <div class="item-title">Change Password</div>
                        <div class="item-description">Update your login password</div>
                    </div>
                </a>
            <div class="section-content">
                <a href="{{ url_for('list_events') }}" class="settings-item">
                    <div class="item-details">
                        <div class="item-title">Event History</div>
                        <div class="item-description">View security events and alerts</div>
                    </div>
                </a>
                
                <a href="#" class="settings-item disabled">
                    <div class="item-details">
                        <div class="item-title">Alert Settings</div>
                        <div class="item-description">Configure notifications and alerts</div>
                    </div>
                </a>
                
                <a href="#" class="settings-item disabled">
                    <div class="item-details">
                        <div class="item-title">Backup & Export</div>
                        <div class="item-description">Export configuration and event data</div>
                    </div>
                </a>
            </div>
        </div>
    </div>
</div>

<style>
.settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.settings-section {
    background: #34495e;
    border-radius: 8px;
    border: 1px solid #2c3e50;
    overflow: hidden;
}

.section-header {
    background: #2c3e50;
    padding: 15px 20px;
    border-bottom: 1px solid #34495e;
}

.section-header h4 {
    margin: 0;
    color: #ecf0f1;
    font-size: 1.1em;
    display: flex;
    align-items: center;
    gap: 8px;
}

.section-content {
    padding: 0;
}

.settings-item {
    display: flex;
    padding: 15px 20px;
    color: #ecf0f1;
    text-decoration: none;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    transition: background 0.3s;
    align-items: center;
    justify-content: space-between;
}

.items-actions {
    margin-left: 15px;
}

.update-button {
    background: #3498db;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9em;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.3s;
}

.update-button:hover {
    background: #2980b9;
}

.update-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.settings-item:hover:not(.disabled) {
    background: #3c5572;
    color: #ecf0f1;
    text-decoration: none;
}

.settings-item.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.settings-item:last-child {
    border-bottom: none;
}

.item-title {
    font-weight: 600;
    margin-bottom: 3px;
}

.item-description {
    font-size: 0.9em;
    color: #bdc3c7;
}

.update-status {
    margin-top: 10px;
    padding: 10px;
    background: rgba(0,0,0,0.2);
    border-radius: 4px;
    font-size: 0.85em;
}

.status-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
}

.status-row:last-child {
    margin-bottom: 0;
}

.status-row .label {
    color: #bdc3c7;
}

.status-row .value {
    color: #ecf0f1;
    font-family: 'Courier New', monospace;
}

.item-actions {
    margin-left: 15px;
}

.update-button {
    background: #3498db;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9em;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.3s;
}

.update-button:hover {
    background: #2980b9;
}

.update-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.update-available {
    background: #e67e22 !important;
}

.update-available:hover {
    background: #d35400 !important;
}

</style>

<script>
    let updateStatusCache = null;
    
    function loadUpdateStatus() {
        fetch('/api/update/status')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const commitElement = document.getElementById('current-commit');
                    if (commitElement) {
                        commitElement.textContent = data.current_commit;
                    }
                    updateStatusCache = data;
                } else {
                    const commitElement = document.getElementById('current-commit');
                    if (commitElement) {
                        commitElement.textContent = 'Git not available';
                    }
                }
            })
            .catch(error => {
                console.error('Error loading update status:', error);
                const commitElement = document.getElementById('current-commit');
                if (commitElement) {
                    commitElement.textContent = 'Error';
                }
            });
    }
    
    function checkForUpdates() {
        const button = event.target.closest('.update-button');
        const originalContent = button.innerHTML;
        
        // Show loading state
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Checking...';
        button.disabled = true;
        
        fetch('/api/update/check')
            .then(response => response.json())
            .then(data => {
                const now = new Date().toLocaleString();
                document.getElementById('last-check').textContent = now;
                
                if (data.success) {
                    if (data.update_available) {
                        // Show update available
                        button.innerHTML = '<i class="fas fa-download"></i>Update Available';
                        button.classList.add('update-available');
                        button.disabled = false; // Re-enable the button
                        
                        // Remove the old onclick and add new one
                        button.removeAttribute('onclick');
                        button.onclick = () => showUpdateModal(data);
                        
                        const changesText = data.changes.length > 0 ? 
                            `\n\nRecent changes:\n${data.changes.slice(0, 5).join('\n')}` : '';
                        
                        alert(`ðŸŽ‰ Update Available!\n\nCurrent: ${data.current_commit}\nLatest: ${data.remote_commit}${changesText}\n\nClick "Update Available" button to install.`);
                    } else {
                        button.innerHTML = originalContent;
                        button.disabled = false;
                        alert(`âœ… You're up to date!\n\nCurrent commit: ${data.current_commit}`);
                    }
                } else {
                    button.innerHTML = originalContent;
                    button.disabled = false;
                    alert(`âŒ Error checking for updates: ${data.error}`);
                }
            })
            .catch(error => {
                button.innerHTML = originalContent;
                button.disabled = false;
                alert(`âš ï¸ Network error: ${error.message}`);
            });
    }
    
    function showUpdateModal(updateData) {
        const changesText = updateData.changes.length > 0 ? 
            `\nChanges to be applied:\n${updateData.changes.join('\n')}\n` : '';
        
        const confirmUpdate = confirm(
            `Install Update?\n\n` +
            `Current: ${updateData.current_commit}\n` +
            `New: ${updateData.remote_commit}\n` +
            `${changesText}\n` +
            `WARNING: The hub will restart automatically after update.\n\n` +
            `Continue with update?`
        );
        
        if (confirmUpdate) {
            performUpdate();
        }
    }
    
    function performUpdate() {
        const button = document.querySelector('.update-available');
        const originalContent = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Updating...';
        button.disabled = true;
        
        fetch('/api/update/perform', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`âœ… Update completed successfully!\n\nThe hub will restart in 5 seconds.\n\nChanges applied:\n${data.changes_pulled}`);
                
                // Show countdown
                let countdown = 5;
                const countdownInterval = setInterval(() => {
                    button.innerHTML = `<i class="fas fa-clock"></i>Restarting in ${countdown}s`;
                    countdown--;
                    
                    if (countdown < 0) {
                        clearInterval(countdownInterval);
                        button.innerHTML = '<i class="fas fa-sync"></i>Restarting...';
                        
                        // Redirect to login after restart
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 3000);
                    }
                }, 1000);
            } else {
                alert(`âŒ Update failed: ${data.error}`);
                button.innerHTML = originalContent;
                button.disabled = false;
            }
        })
        .catch(error => {
            alert(`âš ï¸ Update error: ${error.message}`);
            button.innerHTML = originalContent;
            button.disabled = false;
        });
    }
    
    // Load current version info (keeping your existing version check)
    fetch('/api/version')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('current-version').textContent = `v${data.version}`;
            }
        })
        .catch(error => {
            document.getElementById('current-version').textContent = 'Unknown';
        });
    
    // Load status when page loads
    document.addEventListener('DOMContentLoaded', loadUpdateStatus);


    // Add this at the end of your script section
    document.addEventListener('DOMContentLoaded', function() {
        loadUpdateStatus();
        
        // Attach click handler to the update button
        const updateButton = document.getElementById('check-updates-btn');
        if (updateButton) {
            updateButton.addEventListener('click', checkForUpdates);
        }
    });
</script>
{% endblock %}